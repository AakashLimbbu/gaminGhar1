<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GamingGhar - Profile</title>
  <link rel="stylesheet" href="homepage.css">
</head>
<body>

  <button class="dark-toggle" id="darkToggle">üåì</button>

  <header class="navbar">
    <div class="left-nav">
      <img src="pp.jpg" class="profile-img" id="profileImage1" onclick="location.reload();" style="cursor:pointer;">
      <img src="logo.png" class="logo" onclick="location.href='dashboard.html'" style="cursor:pointer;">
    </div>
    <div class="navbar-right">
      <span class="user-info" id="userInfo"></span>
      <button class="logout-btn" onclick="handleLogout()">Logout</button>
      <button class="delete-btn" onclick="deleteAccount()">Delete Account</button>
    </div>
  </header>

  <main class="profile-page">
    <div class="profile-container">
      <div class="profile-header">
        <img src="pp.jpg" class="profile-large" alt="Profile Picture" id="profileImage2">
        <div class="profile-info">
          <h1 id="profileUsername">-</h1>
          <p id="profileEmail">-</p>
          <p id="profilePhone">-</p>
        </div>
      </div>
      
      <div class="profile-stats">
        <div class="stat-item">
          <span class="stat-label">Member Since</span>
          <span class="stat-value" id="profileMemberSince">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Tournaments Joined</span>
          <span class="stat-value" id="profileTournamentsCount">0</span>
        </div>
      </div>

      <div class="profile-actions">
        <button class="edit-profile-btn" onclick="showEditProfileForm()">Edit Profile</button>
        <button class="change-photo-btn" onclick="document.getElementById('photoInput').click()">Change Photo</button>
        <input type="file" id="photoInput" accept="image/*" onchange="changeProfilePhoto(event)" style="display: none;">
      </div>

      <!-- Edit Profile Form -->
      <div id="editProfileForm" class="edit-profile-form" style="display: none;">
        <h2>Edit Profile</h2>
        <form id="updateProfileForm">
          <div class="form-group">
            <label for="editUsername">Username</label>
            <input type="text" id="editUsername" required>
          </div>
          
          <div class="form-group">
            <label for="editEmail">Email</label>
            <input type="email" id="editEmail" required>
          </div>
          
          <div class="form-group">
            <label for="editPhone">Phone</label>
            <input type="tel" id="editPhone" required>
          </div>
          
          <div class="form-group">
            <label for="editPassword">New Password (optional)</label>
            <input type="password" id="editPassword" placeholder="Leave blank to keep current password">
          </div>
          
          <div class="form-group">
            <label for="editConfirmPassword">Confirm New Password</label>
            <input type="password" id="editConfirmPassword" placeholder="Confirm new password">
          </div>
          
          <div class="form-actions">
            <button type="submit" class="save-profile-btn">Save Changes</button>
            <button type="button" class="cancel-btn" onclick="hideEditProfileForm()">Cancel</button>
          </div>
          
          <div class="form-messages">
            <div class="error-message" id="editErrorMessage"></div>
            <div class="success-message" id="editSuccessMessage"></div>
          </div>
        </form>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-left">
        <div class="footer-links">
          <a href="#" onclick="showPrivacyPolicy(); return false;">Privacy Policy</a>
          <a href="#" onclick="showTermsOfService(); return false;">Terms Of Service</a>
        </div>
        <div class="footer-contact">
          Contact Us: gamingghar@example.com
        </div>
        <div class="footer-copyright">
          ¬© Gaming Ghar. All rights reserved.
        </div>
      </div>
      <div class="footer-right">
        <a href="https://facebook.com" target="_blank" class="social-icon" title="Facebook">
          <svg viewBox="0 0 24 24">
            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
          </svg>
        </a>
        <a href="https://twitter.com" target="_blank" class="social-icon" title="Twitter/X">
          <svg viewBox="0 0 24 24">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
          </svg>
        </a>
        <a href="https://instagram.com" target="_blank" class="social-icon" title="Instagram">
          <svg viewBox="0 0 24 24">
            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zM5.838 12a6.162 6.162 0 1 1 12.324 0 6.162 6.162 0 0 1-12.324 0zM12 16a4 4 0 1 1 0-8 4 4 0 0 1 0 8zm4.965-10.405a1.44 1.44 0 1 1 2.881.001 1.44 1.44 0 0 1-2.881-.001z"/>
          </svg>
        </a>
        <a href="https://tiktok.com" target="_blank" class="social-icon" title="TikTok">
          <svg viewBox="0 0 24 24">
            <path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.41-1.11 1.04-1.36 1.75-.21.51-.15 1.07-.14 1.61.24 1.64 1.82 3.02 3.5 2.87 1.12-.01 2.19-.66 2.77-1.61.19-.33.4-.67.41-1.06.1-1.79.06-3.57.07-5.36.01-4.03-.01-8.05.02-12.07z"/>
          </svg>
        </a>
        <a href="https://youtube.com" target="_blank" class="social-icon" title="YouTube">
          <svg viewBox="0 0 24 24">
            <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
          </svg>
        </a>
        <a href="#" class="social-icon" title="Gaming Ghar">
          <svg viewBox="0 0 24 24">
            <text x="12" y="16" text-anchor="middle" fill="white" font-size="10" font-weight="bold">GG</text>
          </svg>
        </a>
      </div>
    </div>
  </footer>

  <!-- Privacy Policy Modal -->
  <div id="privacyModal" class="policy-modal">
    <div class="policy-content">
      <div class="policy-header">
        <h2 class="policy-title">Privacy Policy</h2>
        <button class="policy-close" onclick="closePrivacyModal()">&times;</button>
      </div>
      <div class="policy-section">
        <h3>Information We Collect</h3>
        <p>We collect information you provide directly to us, such as when you create an account, register for tournaments, or contact us.</p>
        <ul>
          <li>Personal information (name, email, phone number)</li>
          <li>Account information (username, password)</li>
          <li>Tournament participation data</li>
        </ul>
      </div>
      <div class="policy-section">
        <h3>How We Use Your Information</h3>
        <p>We use information we collect to:</p>
        <ul>
          <li>Provide and maintain our services</li>
          <li>Process tournament registrations</li>
          <li>Communicate with you about tournaments</li>
          <li>Improve our services</li>
        </ul>
      </div>
      <div class="policy-section">
        <h3>Data Security</h3>
        <p>We implement appropriate security measures to protect your personal information against unauthorized access, alteration, disclosure, or destruction.</p>
      </div>
      <div class="policy-section">
        <h3>Contact Us</h3>
        <p>If you have any questions about this Privacy Policy, please contact us at gamingghar@example.com</p>
      </div>
    </div>
  </div>

  <!-- Terms of Service Modal -->
  <div id="termsModal" class="policy-modal">
    <div class="policy-content">
      <div class="policy-header">
        <h2 class="policy-title">Terms of Service</h2>
        <button class="policy-close" onclick="closeTermsModal()">&times;</button>
      </div>
      <div class="policy-section">
        <h3>Acceptance of Terms</h3>
        <p>By accessing and using Gaming Ghar, you accept and agree to be bound by terms and provision of this agreement.</p>
      </div>
      <div class="policy-section">
        <h3>User Responsibilities</h3>
        <p>As a user of Gaming Ghar, you agree to:</p>
        <ul>
          <li>Provide accurate and complete information</li>
          <li>Maintain security of your account</li>
          <li>Participate fairly in tournaments</li>
          <li>Not engage in cheating or unfair practices</li>
          <li>Respect other users and follow community guidelines</li>
        </ul>
      </div>
      <div class="policy-section">
        <h3>Tournament Rules</h3>
        <p>All tournament participants must follow specific rules of each tournament, including but not limited to:</p>
        <ul>
          <li>Entry fee requirements</li>
          <li>Match scheduling</li>
          <li>Game-specific rules and regulations</li>
          <li>Sportsmanship and conduct</li>
        </ul>
      </div>
      <div class="policy-section">
        <h3>Limitation of Liability</h3>
        <p>Gaming Ghar is not liable for any losses, damages, or disputes arising from tournament participation. Users participate at their own risk.</p>
      </div>
      <div class="policy-section">
        <h3>Changes to Terms</h3>
        <p>We reserve the right to modify these terms at any time. Changes will be effective immediately upon posting.</p>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:5000/api';

    function checkAuth() {
      const token = localStorage.getItem('token');
      const user = localStorage.getItem('user');

      if (!token || !user) {
        window.location.href = 'index.html';
        return false;
      }

      const userData = JSON.parse(user);
      document.getElementById('userInfo').textContent = `Welcome, ${userData.username}!`;
      return true;
    }

    function handleLogout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = 'index.html';
    }

    async function deleteAccount() {
      const userData = JSON.parse(localStorage.getItem('user') || '{}');
      const confirmMessage = `Are you sure you want to delete your account "${userData.username || 'your account'}"? This action cannot be undone and will permanently delete all your data including tournaments.`;
      
      if (!confirm(confirmMessage)) {
        return;
      }

      const finalConfirmMessage = 'This will permanently delete ALL your data. Type "DELETE" to confirm:';
      const confirmation = prompt(finalConfirmMessage);
      
      if (confirmation !== 'DELETE') {
        alert('Account deletion cancelled. Confirmation text did not match.');
        return;
      }

      try {
        const token = localStorage.getItem('token');
        if (!token) {
          throw new Error('No authentication token found. Please log in again.');
        }

        const deleteBtn = document.querySelector('.delete-btn');
        const originalText = deleteBtn.textContent;
        deleteBtn.textContent = 'Deleting...';
        deleteBtn.disabled = true;

        const response = await fetch(`${API_URL}/auth/account`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          alert('‚úÖ Account deleted successfully. You will be redirected to the login page.');
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          localStorage.removeItem('darkMode');
          window.location.href = 'index.html';
        } else {
          const errorData = await response.json();
          alert(`‚ùå Failed to delete account: ${errorData.error || 'Unknown error'}`);
          deleteBtn.textContent = originalText;
          deleteBtn.disabled = false;
        }
      } catch (error) {
        console.error('Delete account error:', error);
        alert('‚ùå Failed to delete account. Please check your internet connection.');
        const deleteBtn = document.querySelector('.delete-btn');
        deleteBtn.textContent = 'Delete Account';
        deleteBtn.disabled = false;
      }
    }

    function loadProfileData() {
      const userData = JSON.parse(localStorage.getItem('user') || '{}');
      
      // Populate profile information
      document.getElementById('profileUsername').textContent = userData.username || 'Unknown';
      document.getElementById('profileEmail').textContent = userData.email || 'Not provided';
      document.getElementById('profilePhone').textContent = userData.phone || 'Not provided';
      
      // Set profile image
      const profileImage = localStorage.getItem('profileImage2') || 'pp.jpg';
      document.getElementById('profileImage2').src = profileImage; 
      document.getElementById('profileImage1').src = profileImage;

      // Format member since date
      if (userData.created_at) {
        const createdDate = new Date(userData.created_at);
        const dateStr = createdDate.toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
        document.getElementById('profileMemberSince').textContent = dateStr;
      } else {
        document.getElementById('profileMemberSince').textContent = 'Unknown';
      }
      
      // For now, set tournaments count to 0 (can be fetched from API later)
      document.getElementById('profileTournamentsCount').textContent = '0';
    }

    function showEditProfileForm() {
      const userData = JSON.parse(localStorage.getItem('user') || '{}');
      
      // Populate form with current user data
      document.getElementById('editUsername').value = userData.username || '';
      document.getElementById('editEmail').value = userData.email || '';
      document.getElementById('editPhone').value = userData.phone || '';
      
      // Clear password fields
      document.getElementById('editPassword').value = '';
      document.getElementById('editConfirmPassword').value = '';
      
      // Clear messages
      hideEditMessages();
      
      // Show form
      document.getElementById('editProfileForm').style.display = 'block';
    }

    function hideEditProfileForm() {
      document.getElementById('editProfileForm').style.display = 'none';
    }

    function changeProfilePhoto(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const newImageSrc = e.target.result;
          document.getElementById('profileImage').src = newImageSrc;
          // Save to localStorage
          localStorage.setItem('profileImage', newImageSrc);
          // Update all profile images on the page
          document.querySelectorAll('.profile-img, .profile-large').forEach(img => {
            img.src = newImageSrc;
          });
        };
        reader.readAsDataURL(file);
      }
    }

    function hideEditMessages() {
      document.getElementById('editErrorMessage').style.display = 'none';
      document.getElementById('editSuccessMessage').style.display = 'none';
    }

    function showEditError(message) {
      const errorMessage = document.getElementById('editErrorMessage');
      const successMessage = document.getElementById('editSuccessMessage');
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      successMessage.style.display = 'none';
    }

    function showEditSuccess(message) {
      const successMessage = document.getElementById('editSuccessMessage');
      const errorMessage = document.getElementById('editErrorMessage');
      successMessage.textContent = message;
      successMessage.style.display = 'block';
      errorMessage.style.display = 'none';
    }

    // Update Profile Form Handler
    document.getElementById('updateProfileForm').addEventListener('submit', handleUpdateProfile);

    async function handleUpdateProfile(e) {
      e.preventDefault();

      const token = localStorage.getItem('token');
      if (!token) {
        showEditError('Please login first');
        return;
      }

      const username = document.getElementById('editUsername').value.trim();
      const email = document.getElementById('editEmail').value.trim();
      const phone = document.getElementById('editPhone').value.trim();
      const password = document.getElementById('editPassword').value;
      const confirmPassword = document.getElementById('editConfirmPassword').value;

      // Validation
      if (!username || !email || !phone) {
        showEditError('Please fill in all required fields');
        return;
      }

      if (password && password !== confirmPassword) {
        showEditError('Passwords do not match');
        return;
      }

      if (password && password.length < 6) {
        showEditError('Password must be at least 6 characters long');
        return;
      }

      try {
        const saveBtn = document.querySelector('.save-profile-btn');
        const originalText = saveBtn.textContent;
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        const updateData = {
          username,
          email,
          phone
        };

        // Only include password if it's provided
        if (password) {
          updateData.password = password;
        }

        const response = await fetch(`${API_URL}/auth/profile`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(updateData)
        });

        const data = await response.json();

        if (response.ok) {
          // Update localStorage with new user data
          const userData = JSON.parse(localStorage.getItem('user') || '{}');
          userData.username = username;
          userData.email = email;
          userData.phone = phone;
          localStorage.setItem('user', JSON.stringify(userData));

          // Update welcome message in navbar
          document.getElementById('userInfo').textContent = `Welcome, ${username}!`;

          showEditSuccess('‚úÖ Profile updated successfully!');
          
          // Update profile display
          document.getElementById('profileUsername').textContent = username;
          document.getElementById('profileEmail').textContent = email;
          document.getElementById('profilePhone').textContent = phone;
          
          // Close form after success
          setTimeout(() => {
            hideEditProfileForm();
          }, 1500);
        } else {
          showEditError(data.error || 'Failed to update profile');
        }
      } catch (error) {
        console.error('Update profile error:', error);
        showEditError('Failed to update profile. Please check your connection.');
      } finally {
        const saveBtn = document.querySelector('.save-profile-btn');
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Changes';
      }
    }

    // Policy Modal Functions
    function showPrivacyPolicy() {
      document.getElementById('privacyModal').style.display = 'block';
    }

    function closePrivacyModal() {
      document.getElementById('privacyModal').style.display = 'none';
    }

    function showTermsOfService() {
      document.getElementById('termsModal').style.display = 'block';
    }

    function closeTermsModal() {
      document.getElementById('termsModal').style.display = 'none';
    }

    // Dark mode toggle
    const darkToggle = document.getElementById('darkToggle');
    const isDarkMode = localStorage.getItem('darkMode') === 'true';

    if (isDarkMode) {
      document.body.classList.add('dark');
      darkToggle.textContent = '‚òÄÔ∏è';
    }

    darkToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      const isDark = document.body.classList.contains('dark');
      localStorage.setItem('darkMode', isDark);
      darkToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåì';
    });

    // Close modals when clicking outside
    window.onclick = function(event) {
      const privacyModal = document.getElementById('privacyModal');
      const termsModal = document.getElementById('termsModal');
      
      if (event.target === privacyModal) {
        closePrivacyModal();
      }
      if (event.target === termsModal) {
        closeTermsModal();
      }
    }

    if (checkAuth()) {
      loadProfileData();
    }
  </script>

</body>
</html>
